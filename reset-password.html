<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Åifre SÄ±fÄ±rlama - Swanky Software</title>
    <meta name="description" content="Yeni ÅŸifrenizi belirleyin ve hesabÄ±nÄ±za gÃ¼venli bir ÅŸekilde eriÅŸim saÄŸlayÄ±n.">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" href="other_icons/swanky_logo.png">
    <link rel="apple-touch-icon" href="other_icons/swanky_logo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <header class="header">
        <div class="header-content">
            <h1>ğŸ” Åifre SÄ±fÄ±rlama</h1>
            <p>Yeni ÅŸifrenizi belirleyin</p>
        </div>
    </header>

    <main class="main">
        <div class="content-card reset-card">
            <div class="reset-content">
                <div class="reset-icon">
                    <div class="key-circle">
                        <div class="key-icon">ğŸ”‘</div>
                    </div>
                </div>

                <h2>Yeni Åifre Belirleyin</h2>
                <p class="reset-message">
                    HesabÄ±nÄ±zÄ±n gÃ¼venliÄŸi iÃ§in gÃ¼Ã§lÃ¼ bir ÅŸifre seÃ§in. Åifreniz en az 8 karakter olmalÄ± ve bÃ¼yÃ¼k harf,
                    kÃ¼Ã§Ã¼k harf, rakam iÃ§ermelidir.
                </p>

                <form class="reset-form" id="resetForm">
                    <div class="form-group">
                        <label for="password">Yeni Åifre</label>
                        <div class="password-input-wrapper">
                            <input type="password" id="password" name="password" required placeholder="En az 8 karakter"
                                minlength="8">
                            <button type="button" class="toggle-password" onclick="togglePassword('password')">
                                ğŸ‘ï¸
                            </button>
                        </div>
                        <div class="password-strength" id="passwordStrength"></div>
                    </div>

                    <div class="form-group">
                        <label for="confirmPassword">Åifre TekrarÄ±</label>
                        <div class="password-input-wrapper">
                            <input type="password" id="confirmPassword" name="confirmPassword" required
                                placeholder="Åifrenizi tekrar girin">
                            <button type="button" class="toggle-password" onclick="togglePassword('confirmPassword')">
                                ğŸ‘ï¸
                            </button>
                        </div>
                        <div class="password-match" id="passwordMatch"></div>
                    </div>

                    <button type="submit" class="submit-button" id="submitButton" disabled>
                        <span class="button-text">Åifreyi GÃ¼ncelle</span>
                        <span class="button-loading" style="display: none;">â³ GÃ¼ncelleniyor...</span>
                    </button>
                </form>

                <div class="success-message" id="successMessage" style="display: none;">
                    <div class="success-icon-small">âœ…</div>
                    <h3>Åifre BaÅŸarÄ±yla GÃ¼ncellendi!</h3>
                    <p>ArtÄ±k yeni ÅŸifrenizle uygulamaya giriÅŸ yapabilirsiniz.</p>
                </div>

                <div class="error-message" id="errorMessage" style="display: none;">
                    <div class="error-icon">âŒ</div>
                    <h3>Bir Hata OluÅŸtu</h3>
                    <p id="errorText">Åifre gÃ¼ncellenirken bir sorun yaÅŸandÄ±. LÃ¼tfen tekrar deneyin.</p>
                </div>

                <div class="help-section">
                    <h3>GÃ¼venlik Ä°puÃ§larÄ±</h3>
                    <ul class="security-tips">
                        <li>En az 8 karakter kullanÄ±n</li>
                        <li>BÃ¼yÃ¼k ve kÃ¼Ã§Ã¼k harf karÄ±ÅŸÄ±mÄ± yapÄ±n</li>
                        <li>Rakam ve Ã¶zel karakter ekleyin</li>
                        <li>KiÅŸisel bilgilerinizi kullanmayÄ±n</li>
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>Â© 2025 Muhammed Mustafa Geldi | Swanky Software | TÃ¼rkiye</p>
        <p><a href="index.html">â† Ana Sayfaya DÃ¶n</a></p>
    </footer>

    <style>
        /* Reset Password Specific Styles */
        .reset-card {
            text-align: center;
            max-width: 500px;
            margin: 0 auto;
        }

        .reset-content {
            padding: 1rem 0;
        }

        .reset-icon {
            margin: 1rem 0;
        }

        .key-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--primary-color);
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: scaleIn 0.6s ease-out;
        }

        .key-icon {
            font-size: 2rem;
            animation: rotateIn 0.8s ease-out 0.3s both;
        }

        .reset-message {
            font-size: 1rem;
            margin: 1.5rem 0 2rem;
            color: var(--text-secondary);
            text-align: left;
        }

        .reset-form {
            text-align: left;
            margin: 2rem 0;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .password-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem 3rem 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--bg-card);
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(65, 100, 74, 0.1);
        }

        .toggle-password {
            position: absolute;
            right: 0.75rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.25rem;
            border-radius: var(--radius-sm);
            transition: background-color 0.2s ease;
        }

        .toggle-password:hover {
            background: rgba(65, 100, 74, 0.1);
        }

        .password-strength {
            margin-top: 0.5rem;
            font-size: 0.875rem;
            height: 1.2rem;
        }

        .password-match {
            margin-top: 0.5rem;
            font-size: 0.875rem;
            height: 1.2rem;
        }

        .strength-weak {
            color: #dc2626;
        }

        .strength-medium {
            color: #f59e0b;
        }

        .strength-strong {
            color: #16a34a;
        }

        .match-error {
            color: #dc2626;
        }

        .match-success {
            color: #16a34a;
        }

        .submit-button {
            width: 100%;
            padding: 1rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1rem;
        }

        .submit-button:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .submit-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .success-message,
        .error-message {
            margin: 2rem 0;
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            text-align: center;
        }

        .success-message {
            background: rgba(22, 163, 74, 0.1);
            border: 1px solid rgba(22, 163, 74, 0.2);
            color: #16a34a;
        }

        .error-message {
            background: rgba(220, 38, 38, 0.1);
            border: 1px solid rgba(220, 38, 38, 0.2);
            color: #dc2626;
        }

        .success-icon-small,
        .error-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .help-section {
            margin: 2rem 0;
            padding: 1.5rem;
            background: rgba(65, 100, 74, 0.05);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(65, 100, 74, 0.1);
            text-align: left;
        }

        .help-section h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            text-align: center;
        }

        .security-tips {
            list-style: none;
            padding: 0;
        }

        .security-tips li {
            padding: 0.5rem 0;
            position: relative;
            padding-left: 1.5rem;
        }

        .security-tips li::before {
            content: "âœ“";
            position: absolute;
            left: 0;
            color: var(--primary-color);
            font-weight: bold;
        }

        /* Animations */
        @keyframes scaleIn {
            0% {
                opacity: 0;
                transform: scale(0);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes rotateIn {
            0% {
                opacity: 0;
                transform: rotate(-180deg);
            }

            100% {
                opacity: 1;
                transform: rotate(0deg);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .key-circle {
                width: 60px;
                height: 60px;
            }

            .key-icon {
                font-size: 1.5rem;
            }

            .help-section {
                padding: 1rem;
            }
        }
    </style>

    <script>
        // Supabase client initialization
        const supabaseUrl = 'https://deoisgfxlyltqtcpnbjl.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRlb2lzZ2Z4bHlsdHF0Y3BuYmpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NzI2NDksImV4cCI6MjA2NjM0ODY0OX0.NM5LI2aS_FUwzQs1o8ssQGrTIsYb-I_s8NRcsFji78U'
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;

            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'ğŸ™ˆ';
            } else {
                input.type = 'password';
                button.textContent = 'ğŸ‘ï¸';
            }
        }

        function checkPasswordStrength(password) {
            const strengthElement = document.getElementById('passwordStrength');
            let strength = 0;
            let message = '';

            if (password.length >= 8) strength++;
            if (/[a-z]/.test(password)) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;

            if (password.length === 0) {
                strengthElement.textContent = '';
                return false;
            } else if (strength < 3) {
                message = 'âŒ ZayÄ±f ÅŸifre';
                strengthElement.className = 'password-strength strength-weak';
            } else if (strength < 4) {
                message = 'âš ï¸ Orta gÃ¼Ã§lÃ¼kte ÅŸifre';
                strengthElement.className = 'password-strength strength-medium';
            } else {
                message = 'âœ… GÃ¼Ã§lÃ¼ ÅŸifre';
                strengthElement.className = 'password-strength strength-strong';
            }

            strengthElement.textContent = message;
            return strength >= 3;
        }

        function checkPasswordMatch() {
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const matchElement = document.getElementById('passwordMatch');

            if (confirmPassword.length === 0) {
                matchElement.textContent = '';
                return false;
            }

            if (password === confirmPassword) {
                matchElement.textContent = 'âœ… Åifreler eÅŸleÅŸiyor';
                matchElement.className = 'password-match match-success';
                return true;
            } else {
                matchElement.textContent = 'âŒ Åifreler eÅŸleÅŸmiyor';
                matchElement.className = 'password-match match-error';
                return false;
            }
        }

        function updateSubmitButton() {
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const submitButton = document.getElementById('submitButton');

            const isPasswordStrong = checkPasswordStrength(password);
            const isPasswordMatch = checkPasswordMatch();

            submitButton.disabled = !(isPasswordStrong && isPasswordMatch && password.length >= 8);
        }

        // Event listeners
        document.getElementById('password').addEventListener('input', updateSubmitButton);
        document.getElementById('confirmPassword').addEventListener('input', updateSubmitButton);

        // Form submission
        document.getElementById('resetForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const submitButton = document.getElementById('submitButton');
            const buttonText = submitButton.querySelector('.button-text');
            const buttonLoading = submitButton.querySelector('.button-loading');
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');

            // Show loading state
            buttonText.style.display = 'none';
            buttonLoading.style.display = 'inline';
            submitButton.disabled = true;

            try {
                // Get the access token from URL (try both hash and search params)
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                const searchParams = new URLSearchParams(window.location.search);

                const accessToken = hashParams.get('access_token') || searchParams.get('access_token');
                const refreshToken = hashParams.get('refresh_token') || searchParams.get('refresh_token');

                if (!accessToken) {
                    throw new Error('GeÃ§ersiz veya sÃ¼resi dolmuÅŸ baÄŸlantÄ±');
                }

                const password = document.getElementById('password').value;

                // Verify the password reset token
                const { data: verifyData, error: verifyError } = await supabase.auth.verifyOtp({
                    token_hash: accessToken,
                    type: 'recovery'
                });

                if (verifyError) {
                    // Handle different types of verification errors
                    let userFriendlyMessage = 'Åifre sÄ±fÄ±rlama baÄŸlantÄ±sÄ± geÃ§ersiz.';

                    if (verifyError.message.includes('expired') || verifyError.message.includes('invalid')) {
                        userFriendlyMessage = 'Åifre sÄ±fÄ±rlama baÄŸlantÄ±sÄ±nÄ±n sÃ¼resi dolmuÅŸ veya geÃ§ersiz. LÃ¼tfen yeni bir ÅŸifre sÄ±fÄ±rlama talebinde bulunun.';
                    } else if (verifyError.message.includes('already_used')) {
                        userFriendlyMessage = 'Bu ÅŸifre sÄ±fÄ±rlama baÄŸlantÄ±sÄ± daha Ã¶nce kullanÄ±lmÄ±ÅŸ. LÃ¼tfen yeni bir ÅŸifre sÄ±fÄ±rlama talebinde bulunun.';
                    } else if (verifyError.message.includes('not_found')) {
                        userFriendlyMessage = 'Åifre sÄ±fÄ±rlama baÄŸlantÄ±sÄ± bulunamadÄ±. LÃ¼tfen yeni bir ÅŸifre sÄ±fÄ±rlama talebinde bulunun.';
                    }

                    throw new Error(userFriendlyMessage);
                }

                // Update the user's password
                const { data: updateData, error: updateError } = await supabase.auth.updateUser({
                    password: password
                });

                if (updateError) {
                    // Handle password update errors
                    let userFriendlyMessage = 'Åifre gÃ¼ncellenirken bir sorun yaÅŸandÄ±.';

                    if (updateError.message.includes('weak_password')) {
                        userFriendlyMessage = 'Åifre Ã§ok zayÄ±f. LÃ¼tfen daha gÃ¼Ã§lÃ¼ bir ÅŸifre seÃ§in.';
                    } else if (updateError.message.includes('same_password')) {
                        userFriendlyMessage = 'Yeni ÅŸifre mevcut ÅŸifrenizle aynÄ± olamaz. LÃ¼tfen farklÄ± bir ÅŸifre seÃ§in.';
                    } else if (updateError.message.includes('session')) {
                        userFriendlyMessage = 'Oturum sÃ¼resi dolmuÅŸ. LÃ¼tfen yeni bir ÅŸifre sÄ±fÄ±rlama talebinde bulunun.';
                    }

                    throw new Error(userFriendlyMessage);
                }

                // Show success message
                document.querySelector('.reset-form').style.display = 'none';
                document.querySelector('.help-section').style.display = 'none';
                successMessage.style.display = 'block';

                // Clear the URL hash for security
                window.history.replaceState(null, null, window.location.pathname);

                // Clear form data for security
                document.getElementById('password').value = '';
                document.getElementById('confirmPassword').value = '';

            } catch (error) {
                errorText.textContent = error.message || 'Åifre gÃ¼ncellenirken beklenmeyen bir sorun yaÅŸandÄ±. LÃ¼tfen tekrar deneyin.';
                errorMessage.style.display = 'block';

                // Reset button state
                buttonText.style.display = 'inline';
                buttonLoading.style.display = 'none';
                submitButton.disabled = false;
            }
        });

        // Prevent back button after successful reset
        window.addEventListener('pageshow', function (event) {
            if (event.persisted && document.getElementById('successMessage').style.display === 'block') {
                window.location.reload();
            }
        });

        // Check if we have the necessary tokens on page load
        window.addEventListener('load', function () {
            // Try to get parameters from both hash and search
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            const searchParams = new URLSearchParams(window.location.search);

            let accessToken = hashParams.get('access_token') || searchParams.get('access_token');
            let error = hashParams.get('error') || searchParams.get('error');
            let errorDescription = hashParams.get('error_description') || searchParams.get('error_description');

            // Check for errors first
            if (error) {
                let errorMessage = 'Bir hata oluÅŸtu.';

                if (error === 'access_denied') {
                    if (errorDescription && errorDescription.includes('expired')) {
                        errorMessage = 'Åifre sÄ±fÄ±rlama baÄŸlantÄ±sÄ±nÄ±n sÃ¼resi dolmuÅŸ. LÃ¼tfen yeni bir ÅŸifre sÄ±fÄ±rlama talebinde bulunun.';
                    } else {
                        errorMessage = 'EriÅŸim reddedildi. LÃ¼tfen yeni bir ÅŸifre sÄ±fÄ±rlama talebinde bulunun.';
                    }
                }

                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorText').textContent = errorMessage;
                document.querySelector('.reset-form').style.display = 'none';
                document.querySelector('.help-section').style.display = 'none';
                return;
            }

            // Check if this is a password recovery request
            if (!accessToken) {
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorText').textContent = 'GeÃ§ersiz ÅŸifre sÄ±fÄ±rlama baÄŸlantÄ±sÄ±. LÃ¼tfen yeni bir ÅŸifre sÄ±fÄ±rlama talebinde bulunun.';
                document.querySelector('.reset-form').style.display = 'none';
                document.querySelector('.help-section').style.display = 'none';
            }
        });
    </script>
</body>

</html>